<?php

use App\Models\Author;
use App\Models\Book;
use App\Models\Cart;
use App\Models\CartItem;
use App\Models\Wishlist;
use App\Support\SiteSettingStore;
use Livewire\Component;

new class extends Component
{
        public string $slug = '';
        public ?Author $author = null;
        public string $currency = 'USD';
        public array $wishlistBookIds = [];

        public function addToCart(int $bookId): void
        {
            $user = auth()->user();
            if (! $user) {
                $this->redirectRoute('login');
                return;
            }

            $book = Book::find($bookId);
            if (! $book) {
                return;
            }

            $cart = Cart::firstOrCreate(
                ['user_id' => $user->id, 'status' => 'active'],
                ['checked_out_at' => null]
            );

            $item = CartItem::where('cart_id', $cart->id)
                ->where('book_id', $book->id)
                ->first();

            $quantity = $item ? $item->quantity + 1 : 1;
            $unitPrice = (float) $book->price;

            if ($item) {
                $item->update([
                    'quantity' => $quantity,
                    'unit_price' => $unitPrice,
                    'line_total' => $quantity * $unitPrice,
                ]);
            } else {
                CartItem::create([
                    'cart_id' => $cart->id,
                    'book_id' => $book->id,
                    'quantity' => 1,
                    'unit_price' => $unitPrice,
                    'line_total' => $unitPrice,
                ]);
            }

            $this->dispatch('cart-updated', bookId: $bookId);
        }

    public function addToWishlist(int $bookId): void
    {
        $user = auth()->user();
        if (! $user) {
            $this->redirectRoute('login');
            return;
        }

        $book = Book::find($bookId);
        if (! $book) {
            return;
        }

        $wishlist = Wishlist::where('user_id', $user->id)->where('book_id', $book->id)->first();
        
        if ($wishlist) {
            // Remove from wishlist
            $wishlist->delete();
            if (($key = array_search($bookId, $this->wishlistBookIds)) !== false) {
                unset($this->wishlistBookIds[$key]);
            }
        } else {
            // Add to wishlist
            Wishlist::create([
                'user_id' => $user->id,
                'book_id' => $book->id,
            ]);
            $this->wishlistBookIds[] = $bookId;
        }

        $this->dispatch('wishlist-updated', bookId: $bookId);
    }

    public function decrementFromCart(int $bookId): void
    {
        $user = auth()->user();
        if (! $user) {
            return;
        }

        $cart = Cart::where('user_id', $user->id)->where('status', 'active')->first();
        if (! $cart) {
            return;
        }

        $item = CartItem::where('cart_id', $cart->id)->where('book_id', $bookId)->first();
        if (! $item) {
            return;
        }

        $newQuantity = $item->quantity - 1;
        if ($newQuantity > 0) {
            $item->update([
                'quantity' => $newQuantity,
                'line_total' => $newQuantity * $item->unit_price,
            ]);
        } else {
            $item->delete();
        }

        $this->dispatch('cart-updated', bookId: $bookId);
    }

        public function mount(string $slug): void
        {
                $this->slug = $slug;
        $this->currency = (string) SiteSettingStore::get('currency', 'USD');
        $this->loadWishlist();
        $this->author = Author::query()
            ->with(['books.genreRelation', 'books.formatRelation'])
            ->where('slug', $slug)
            ->firstOrFail();
        }

        public function loadWishlist(): void
        {
            $user = auth()->user();
            if (! $user) {
                return;
            }
            $this->wishlistBookIds = Wishlist::where('user_id', $user->id)->pluck('book_id')->toArray();
        }
};
?>

<main class="page-shell">
    <section class="section reveal author-detail-head">
        <p class="section-subtitle" style="margin:0 0 0.35rem;">
            <a href="{{ route('authors') }}">Authors</a> / <span>{{ $author->name }}</span>
        </p>
        <h1>{{ $author->name }}</h1>
        <p class="muted" style="max-width: 76ch;">{{ $author->bio }}</p>
        <div class="pill-row">
            <span class="pill">{{ $author->specialty }}</span>
            <span class="pill ghost">{{ $author->published_books }} published books</span>
        </div>
    </section>

    <div class="author-detail-layout">
        <aside class="section reveal author-detail-side">
            <div class="author-detail-profile">
                <div class="author-avatar">{{ strtoupper(substr($author->name, 0, 2)) }}</div>
                <div>
                    <h2 class="section-title">Author Profile</h2>
                    <p class="section-subtitle" style="margin:.2rem 0 0;">{{ $author->city }}</p>
                </div>
            </div>

            <ul class="author-fact-list">
                <li class="author-fact">
                    <span>Followers</span>
                    <strong>{{ $author->followers_count }}</strong>
                </li>
                <li class="author-fact">
                    <span>Main Focus</span>
                    <strong>{{ $author->specialty }}</strong>
                </li>
            </ul>

            <p class="author-detail-quote">{{ $author->quote }}</p>

            <div class="pill-row">
                <a class="button" href="{{ route('store') }}">Explore Store</a>
            </div>
        </aside>

        <section class="section reveal author-detail-main">
            <h2 class="section-title">Reader Insights</h2>
            <p class="section-subtitle">What readers can expect from this authorâ€™s writing style and themes.</p>

            <div class="grid cols-3 author-insight-grid">
                <article class="card">
                    <h3>Writing Style</h3>
                    <p class="muted" style="margin:0;">Clear narrative with practical, immersive, and character-led storytelling.</p>
                </article>
                <article class="card">
                    <h3>Best For</h3>
                    <p class="muted" style="margin:0;">Readers seeking depth, consistency, and genre-driven discovery.</p>
                </article>
                <article class="card">
                    <h3>Catalog Strength</h3>
                    <p class="muted" style="margin:0;">Balanced mix of latest releases and established audience favorites.</p>
                </article>
            </div>
        </section>
    </div>

    <section class="section reveal">
        <div class="section-head">
            <div>
                <h2 class="section-title">Books by {{ $author->name }}</h2>
                <p class="section-subtitle">{{ $author->books->count() }} titles available in the catalog.</p>
            </div>
            <a class="button secondary" href="{{ route('store') }}">Browse Store</a>
        </div>
        <div class="grid cols-4">
            @foreach ($author->books as $book)
                <article class="card">
                    <div class="book-cover" style="background: {{ $book->cover_tone ?? '#232f3e' }};">
                        {{ $book->genreRelation?->name ?? $book->genre }}
                    </div>
                    <a href="{{ route('book.detail', ['slug' => $book->slug]) }}" style="text-decoration: none; color: inherit;">
                        <h3>{{ $book->title }}</h3>
                    </a>
                    <p class="muted">{{ $currency }} {{ number_format($book->price, 2) }}</p>
                    <div class="price-row">
                        <strong>{{ $currency }} {{ number_format($book->price, 2) }}</strong>
                        <span>Rating {{ number_format($book->rating, 1) }}</span>
                    </div>
                    <div class="item-actions">
                        <button type="button" class="icon-btn wishlist-btn wishlist-badge" wire:click="addToWishlist({{ $book->id }})" title="Add to Wishlist" data-book-id="{{ $book->id }}" data-in-wishlist="{{ in_array($book->id, $wishlistBookIds) ? 'true' : 'false' }}">
                            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"></path>
                            </svg>
                        </button>
                    </div>
                </article>
            @endforeach
        </div>
    </section>
</main>